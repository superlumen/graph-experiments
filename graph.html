<head>
<meta charset="utf-8">
<style>

rect {
  fill: none;
  pointer-events: all;
}

.node {
  fill: #000;
}

.cursor {
  fill: none;
  stroke: brown;
  pointer-events: none;
}

.link {
  stroke: #999;
}

</style>

<script src="https://cdnjs.cloudflare.com/ajax/libs/d3/3.5.5/d3.min.js"></script>

</head>

<body>

  <script>


  var fixtureNodes = [
    {
      "index": 0,
      "weight": 1,
      "x": 473.2682031835509,
      "y": 237.78242445515852,
      "px": 473.2725323544448,
      "py": 237.79028198774245
    },
    {
      "x": 487.997385670215,
      "y": 264.51468120713264,
      "index": 1,
      "weight": 3,
      "px": 487.9930955782151,
      "py": 264.5068954853199,
      "fixed": 0
    }
  ];
  var fixtureLinks = [
    {
      "source": {
        "x": 487.997385670215,
        "y": 264.51468120713264,
        "index": 1,
        "weight": 3,
        "px": 487.9930955782151,
        "py": 264.5068954853199,
        "fixed": 0
      },
      "target": {
        "index": 0,
        "weight": 1,
        "x": 473.2682031835509,
        "y": 237.78242445515852,
        "px": 473.2725323544448,
        "py": 237.79028198774245
      }
    },
    {
      "source": {
        "x": 487.997385670215,
        "y": 264.51468120713264,
        "index": 1,
        "weight": 3,
        "px": 487.9930955782151,
        "py": 264.5068954853199,
        "fixed": 0
      },
      "target": {
        "x": 487.997385670215,
        "y": 264.51468120713264,
        "index": 1,
        "weight": 3,
        "px": 487.9930955782151,
        "py": 264.5068954853199,
        "fixed": 0
      }
    }
  ]



  var width = 960,
      height = 500;

  var fill = d3.scale.category20();

  var force = d3.layout.force()
      .size([width, height])
      .nodes([{}]) // initialize with a single node
      .linkDistance(30)
      .charge(-60)
      .on("tick", tick);

  var svg = d3.select("body").append("svg")
      .attr("width", width)
      .attr("height", height)
      .on("mousemove", mousemove)
      .on("mousedown", mousedown);

  svg.append("rect")
      .attr("width", width)
      .attr("height", height);

  var nodes = force.nodes(),
      links = force.links(),
      node = svg.selectAll(".node"),
      link = svg.selectAll(".link");

  var cursor = svg.append("circle")
      .attr("r", 30)
      .attr("transform", "translate(-100,-100)")
      .attr("class", "cursor");

  restart();

  function mousemove() {
    cursor.attr("transform", "translate(" + d3.mouse(this) + ")");
  }

  Nodes.find().observeChanges({
    added: function(id, doc){
      // delete doc._id;
      console.log('pushing a node', doc);
      nodes.push(doc);
      // restart();
    }
  });

  Links.find().observeChanges({
    added: function(id, doc) {
      // delete doc._id;
      // debugger
      console.log('pushing link', doc);
      links.push(doc);
      // restart();
    }
  });

  window.newNodesIndexes = [];
  window.newLinksIndexes = [];
  window.allLinks = [];

  function mousedown() {

    force.stop();

    var point = d3.mouse(this),
        node = {x: point[0], y: point[1]},
        n = Nodes.insert(node);
        // n = nodes.push(node);
        // console.log('mousedown', node, n, nodes[n-1]);

        // We want to get this later
        // window.newNodesIndexes.push(n-1);

    var first = true;

    // add links to any nearby nodes
    nodes.forEach(function(target) {

      // Log inside the forEach, but only once
      if (first) {
        // console.log('in forEach', node, n, nodes[n-1], target);
        first = false;
      }


      var x = target.x - node.x,
          y = target.y - node.y;
      if (Math.sqrt(x * x + y * y) < 30) {
        // debugger
        // console.log('adding a new link');
        links.push({source: node, target: target});
        // window.allLinks.push({source: node, target: target});
        // console.log('inserting link', node, target);
        // Links.insert({source: node, target: target});
        // var link = {source: node, target: target};
        // window.newLinksIndexes.push( links.push(link) - 1 );
        // console.log('link', link, node);
      }
    });

    // restart();
  }

  function tick() {
    link.attr("x1", function(d) { return d.source.x; })
        .attr("y1", function(d) { return d.source.y; })
        .attr("x2", function(d) { return d.target.x; })
        .attr("y2", function(d) { return d.target.y; });

    node.attr("cx", function(d) { return d.x; })
        .attr("cy", function(d) { return d.y; });
  }

  function restart() {
    link = link.data(links);

    link.enter().insert("line", ".node")
        .attr("class", "link");

    node = node.data(nodes);

    node.enter().insert("circle", ".cursor")
        .attr("class", "node")
        .attr("r", 5)
        .call(force.drag);

    force.start();
    // debugger
  }

  </script>

</body>
